<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link rel="stylesheet" type="text/css" href="style/iframe.css"> 
        <link rel="stylesheet" type="text/css" href="style/horizontalNav.css">
        <title>Expense Manager</title>

        <script language="javascript" type="text/javascript" src="js/jquery-1.11.3.min.js"></script>

        <?php include 'php/checkSession.php'; ?>

        <script language="javascript" type="text/javascript">
            function saveEntries() {
                var curselMonth = document.getElementById("frame1").contentWindow.selMonth;
                var curselYear =  document.getElementById("frame1").contentWindow.selYear;
                var mainWinHref = document.getElementById("frame2").contentWindow.location.href;
                var data = "";

                if (mainWinHref.indexOf("monthlyEntry.html") > -1)  {
                    if ((curselMonth >= 1 && curselMonth <= 12) &&
                        (curselYear >= 1979 && curselYear <= 9999)) {
                        var table = $("#frame2").contents().find("tbody")[0]; 
                        for (var i = 0, row; row = table.rows[i]; i++) {
                           data += "@"; 
                           for (var j = 0, col; col = row.cells[j]; j++) {
                               switch (j)  {
                                   // date
                                   case 0: 
                                   if (isNaN(Date.parse(col.childNodes[0].value)) == true)
                                        data += "edate="+curselYear+"-"+curselMonth+"-"+"01";
                                   else data += "edate=" + col.childNodes[0].value; 
                                   break;
                                   // category
                                   case 1:
                                   if (col.childNodes[0].value == '')  data += "?category=0";
                                   else data += "?category=" + col.childNodes[0].value; 
                                   break;
                                   // description
                                   case 2:
                                   if (col.childNodes[0].value == '') data += "?description=--Empty--"; 
                                   else data += "?description=" + col.childNodes[0].value; 
                                   break;
                                   // amount
                                   case 3:
                                   if (col.childNodes[0].value == '') data += "?amount=0";
                                   else data += "?amount=" + col.childNodes[0].value; 
                                   break;
                                   default: break;
                               }
                           } 
                        }

                        if (curselMonth < 10) curselMonth = "0" + curselMonth;        
                        $.post("./php/setTableRows.php", {month: curselMonth, 
                                                          year: curselYear, 
                                                          rowEntries: data}).
                              done(function(ret_status) {
                            alert (ret_status);
                        })
                    } else {
                        alert ("Please select a month for saving !");
                    }
                }
            }

            function monthlySummary ()  {
                var curselMonth = document.getElementById("frame1").contentWindow.selMonth;
                var curselYear =  document.getElementById("frame1").contentWindow.selYear;

                if ((curselMonth >= 1 && curselMonth <= 12) &&
                    (curselYear >= 1979 && curselYear <= 9999)) {
                    document.getElementById('frame2').src = "summary";
                }
            }

            function yearlyReport () {
                var curselYear =  document.getElementById("frame1").contentWindow.selYear;

                if (curselYear >= 1979 && curselYear <= 9999) {
                    document.getElementById('frame2').src = "report";
                }
            }

            function download(filename, text) {
                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/csv;charset=utf-8,' + 
                                              encodeURIComponent(text));
                element.setAttribute('download', filename);
                element.style.display = 'none';

                document.body.appendChild(element);
                
                element.click();
                
                document.body.removeChild(element);
            }

            function downloadTable ()   {
                var curselMonth = document.getElementById("frame1").contentWindow.selMonth;
                var curselYear =  document.getElementById("frame1").contentWindow.selYear;

                if ((curselMonth >= 1 && curselMonth <= 12) &&
                    (curselYear >= 1979 && curselYear <= 9999)) {
                    if (curselMonth < 10) curselMonth = "0" + curselMonth;        
                    $.post("./php/mySQLTableDownload.php", {month: curselMonth, 
                                                            year: curselYear}).
                          done(function(ret_status) {
                        download ("ExpenseManager_"+curselMonth+"_"+curselYear+"_.csv", ret_status);
                    })
                }
            }

            function manage ()  {
                document.getElementById('frame2').src = "manage";
            }

            /* 
            *  Function Name: OnPageLoad 
            *  Purpose: Function will be called on page load. Display the manage menu
            *  if user is admin. 
            *  Input : none
            *  Output: none
            */
            $(function() {
                $.post("./php/isAdmin.php").done(function(ret_status) {
                    if (ret_status == 1)
                        $('#manage')[0].style.display       ='';
                    else
                        $('#manage')[0].style.display       ='none';
                })
            })
        </script>
    </head>

    <body>
        <!-- Create hyperlinks to Horizontal Navigation bar  -->
        <ul>
            <li><a class="highlightColor" href="">Happy Home</a></li>

            <ul class="dropdown" style="float:left;list-style-type:none;">
                <li>
                    <a href="javascript:void(0);">Tools &#9662;</a>
                    <ul class="dropdown">
                        <li>
                            <a href="javascript:void(0);" 
                               onclick="javascript:void(0);">Upload</a>
                            <a href="javascript:void(0);" 
                               onclick="javascript:downloadTable();">Download</a>
                        </li>
                    </ul>
                </li>
            </ul>
            <li><a href="javascript:void(0);" 
                   onclick="javascript:saveEntries();">Save</a></li>
            <li><a href="javascript:void(0);"
                   onclick="javascript:yearlyReport();">Report</a></li>
            <li><a href="javascript:void(0);" 
                   onclick="javascript:monthlySummary();">Summary</a></li>
            <ul class="dropdown" style="float:right;list-style-type:none;">
                <li>
                    <a href="javascript:void(0);">
                        <?= ucfirst(strtolower($_SESSION['username'])) ?> &#9662;</a>
                    <ul class="dropdown">
                        <li>
                            <a id="manage" name="manage"
                               style="display:none;"
                               href="javascript:manage();">Manage</a>
                            <a href="php/usrLogout.php">Logout</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </ul>

        <!-- Create frame for vertical navigation bar and main window  -->
        <iframe id="frame1" 
                name="frame1" 
                class="menu" 
                src="verticalNav.html" 
                frameborder="0">
            <p>Your browser does not support iframes.</p>
        </iframe>
        <iframe id="frame2" 
                name="frame2" 
                class="mainContent" 
                src="welcome.html" 
                frameborder="0">
            <p>Your browser does not support iframes.</p>
        </iframe>
    </body>
</html>
