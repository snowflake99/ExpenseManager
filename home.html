<html>
<!--[if lt IE 7]>
    <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
<![endif]-->
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link rel="stylesheet" type="text/css" href="style/iframe.css"> 
        <link rel="stylesheet" type="text/css" href="style/horizontalNav.css">
        <title>Expense Manager</title>

        <script language="javascript" type="text/javascript" src="js/jquery-1.11.3.min.js"></script>

        <?php include 'php/checkSession.php'; ?>

        <script language="javascript" type="text/javascript">
            function _(el){
                return document.getElementById(el);
            }

            function saveEntries() {
                var curselMonth = _("frame1").contentWindow.selMonth;
                var curselYear =  _("frame1").contentWindow.selYear;
                var mainWinHref = _("frame2").contentWindow.location.href;
                var data = "";

                if (mainWinHref.indexOf("monthlyEntry.html") > -1)  {
                    if ((curselMonth >= 1 && curselMonth <= 12) &&
                        (curselYear >= 1979 && curselYear <= 9999)) {
                        var table = $("#frame2").contents().find("tbody")[0]; 
                        for (var i = 0, row; row = table.rows[i]; i++) {
                           data += "@"; 
                           for (var j = 0, col; col = row.cells[j]; j++) {
                               switch (j)  {
                                   // date
                                   case 0: 
                                   if (isNaN(Date.parse(col.childNodes[0].value)) == true)
                                        data += "edate="+curselYear+"-"+curselMonth+"-"+"01";
                                   else data += "edate=" + col.childNodes[0].value; 
                                   break;
                                   // category
                                   case 1:
                                   if (col.childNodes[0].value == '')  data += "?category=0";
                                   else data += "?category=" + col.childNodes[0].value; 
                                   break;
                                   // description
                                   case 2:
                                   if (col.childNodes[0].value == '') data += "?description=--Empty--"; 
                                   else data += "?description=" + col.childNodes[0].value; 
                                   break;
                                   // amount
                                   case 3:
                                   if (col.childNodes[0].value == '') data += "?amount=0";
                                   else data += "?amount=" + col.childNodes[0].value; 
                                   break;
                                   default: break;
                               }
                           } 
                        }

                        if (curselMonth < 10) curselMonth = "0" + curselMonth;        
                        $.post("./php/setTableRows.php", {month: curselMonth, 
                                                          year: curselYear, 
                                                          rowEntries: data}).
                              done(function(ret_status) {
                            alert (ret_status);
                        })
                    } else {
                        alert ("Please select a month for saving !");
                    }
                }
            }

            function monthlySummary ()  {
                var curselMonth = _("frame1").contentWindow.selMonth;
                var curselYear =  _("frame1").contentWindow.selYear;

                if ((curselMonth >= 1 && curselMonth <= 12) &&
                    (curselYear >= 1979 && curselYear <= 9999)) {
                    _('frame2').src = "monthlySummary";
                }
            }

            function yearlyReport () {
                var curselYear =  _("frame1").contentWindow.selYear;

                if (curselYear >= 1979 && curselYear <= 9999) {
                    _('frame2').src = "yearlyReport";
                }
            }

            function download(filename, text) {
                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/csv;charset=utf-8,' + 
                                              encodeURIComponent(text));
                element.setAttribute('download', filename);
                element.style.display = 'none';

                document.body.appendChild(element);
                
                element.click();
                
                document.body.removeChild(element);
            }

            function downloadTable ()   {
                var curselMonth = _("frame1").contentWindow.selMonth;
                var curselYear =  _("frame1").contentWindow.selYear;
                var currency = "<?php echo $_SESSION['currency']?>";
                var sessionUser = "<?php echo $_SESSION['username']?>";

                if ((curselMonth >= 1 && curselMonth <= 12) &&
                    (curselYear >= 1979 && curselYear <= 9999)) {
                    if (curselMonth < 10) curselMonth = "0" + curselMonth;        
                    $.post("./php/tableDownload.php", {month: curselMonth, 
                                                       year: curselYear}).
                          done(function(ret_status) {
                        download ("ExpenseManager_"+
                                   sessionUser+"_"+
                                   curselMonth+"_"+
                                   curselYear+"_"+
                                   currency+".csv", 
                                   ret_status);
                    })
                } else {
                    alert ("Please select a month !");
                }
            }

            function uploadFile(){
                var file = _("uploadFilename").files[0];
                var formdata = new FormData();
                formdata.append("uploadFilename", file);
                var ajax = new XMLHttpRequest();
                ajax.upload.addEventListener("progress", progressHandler, false);
                ajax.addEventListener("load", completeHandler, false);
                ajax.addEventListener("error", errorHandler, false);
                ajax.addEventListener("abort", abortHandler, false);
                ajax.open("POST", "php/tableUpload.php");
                ajax.send(formdata);
            }
            function progressHandler(event){
                var percent = (event.loaded / event.total) * 100;
                console.log (Math.round(percent) + "%" + 
                             " Uploaded Bytes: " + event.loaded + 
                             " Total Bytes: " + event.total); 
            }
            function completeHandler(event){
                alert(event.target.responseText);
            }
            function errorHandler(event){
                alert ("Upload Failed");
            }
            function abortHandler(event){
                alert ("Upload Aborted");
            }

            function manage ()  {
                _('frame2').src = "manage";
            }

            function updatePwd ()  {
                _('frame2').src = "updatePwd";
            }

            /* 
            *  Function Name: OnPageLoad 
            *  Purpose: Function will be called on page load. Display the manage menu
            *  if user is admin. 
            *  Input : none
            *  Output: none
            */
            $(function() {
                _("uploadFilename").addEventListener ('click', function() {
                    _("uploadFilename").value = '';
                }, false);

                $.post("./php/isAdmin.php").done(function(ret_status) {
                    if (ret_status == 1)
                        $('#manage')[0].style.display       ='';
                    else
                        $('#manage')[0].style.display       ='none';
                })
           })
        </script>
    </head>

    <body style="margin: 0 auto;">
        <!-- Hidden Form to upload table data -->
        <form enctype='multipart/form-data' 
              id='uploadForm'
              name='uploadForm'
              style='display:none'
              method='post'>
           <input type="file" 
                  id="uploadFilename" 
                  name="uploadFilename"
                  style="visibility: hidden; width: 1px; height: 1px"
                  onchange="javascript:uploadFile();"
                  multiple />
        </form>

        <!-- Create hyperlinks to Horizontal Navigation bar  -->
        <ul>
            <li>
                <a class="highlightColor" 
                   href="">Expense Manager</a>
            </li>
            <li>
                <a href="javascript:void(0);" 
                   onclick="javascript:saveEntries();">Save</a>
            </li>
            <li>
                <a href="javascript:void(0);">Summary &#9660;</a>
                <ul class="dropdown">
                    <li>
                        <a href="javascript:void(0);"
                            onclick="javascript:yearlyReport();">Yearly</a>
                        <a href="javascript:void(0);" 
                            onclick="javascript:monthlySummary();">Monthly</a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="javascript:void(0);">Tools &#9660;</a>
                <ul class="dropdown">
                    <li>
                        <a href="javascript:void(0);" 
                           onclick="javascript:_('uploadFilename').click();">Upload</a>
                        <a href="javascript:void(0);" 
                           onclick="javascript:downloadTable();">Download</a>
                    </li>
                </ul>
            </li>
            <li class="userMenu">
                <a href="javascript:void(0);">
                    <?= ucfirst(strtolower($_SESSION['username'])).str_repeat('&nbsp;', 
                        1-strlen($_SESSION['username'])); ?> &#9660;</a>
                <ul class="dropdownRightAlign">
                    <li>
                        <a id="manage" name="manage"
                           style="display:none;"
                           href="javascript:manage();">Manage</a>
                        <a href="javascript:void(0);"
                           onclick="javascript:updatePwd();">Password</a>
                        <a href="php/usrLogout.php">Logout</a>
                    </li>
                </ul>
            </li>
        </ul>

        <!-- Create frame for vertical navigation bar and main window  -->
        <iframe id="frame1" 
                name="frame1" 
                class="menu" 
                src="verticalNav.html" 
                style="visibility:hidden; border:0;" 
                onload="this.style.visibility = 'visible';">
            <p>Your browser does not support iframes.</p>
        </iframe>
        <iframe id="frame2" 
                name="frame2" 
                class="mainContent" 
                src="welcome.html" 
                style="visibility:hidden; border:0;" 
                onload="this.style.visibility = 'visible';">
            <p>Your browser does not support iframes.</p>
        </iframe>
    </body>
</html>
