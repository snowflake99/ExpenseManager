<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Yearly Report</title>

        <style>
            table {
                -moz-box-shadow: 0 0 5px #888;
                -webkit-box-shadow: 0 0 5px#888;
                box-shadow: 0 0 5px #888;
                border-collapse: collapse;
                width: 100%;
            }

            th, td {
                text-align: left;
                padding: 8px;
            }
            
            th {
                background-color: #666666;
                color: white;
            }
        </style>
        <script language="javascript" 
                type="text/javascript" 
                src="js/jquery-1.11.3.min.js"></script>

        <?php include 'php/checkSession.php'; ?>

        <script type="text/javascript">
            var canvas;
            var context;
            var xScale;
            var yScale;
            var y;
            // Max and Min value of Y axis
            var Val_Max = 0.0;
            var Val_Min = 0.0;
            // values of each item on the graph
            var itemFullName = [ "January", "February", "March", "April", "May", "June", 
                                 "July", "August", "September", "October", "November", "December"];
            var itemName = [ "Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                             "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            var itemValue = [ 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
            var itemTotal = 0.0;
            
            function plotBarGraph() {
                // intialize values for each variables
                var sections    = 12;
                var columnSize  = 20;
                var rowSize     = 30;
                var margin      = 10;
                var stepSize    = Val_Max/10;

                var header = "Amount" 
                    
                canvas = document.getElementById("canvas");
                context = canvas.getContext("2d");
                context.fillStyle = "#000;"

                yScale = (canvas.height - columnSize - margin) / (Val_Max);
                xScale = (canvas.width - rowSize) / (sections + 1);
    
                context.strokeStyle="#000;"; // background black lines
                context.beginPath();
                // column names 
                context.font = "19 pt Arial;"
                context.fillText(header, 0,columnSize - margin);
                // draw lines in the background
                context.font = "16 pt Helvetica"
                var count =  0;
                
                for (scale=parseFloat(Val_Max).toFixed(4);
                     scale > 0.0 || Math.abs(scale - 0.0) < 0.001;
                     scale = parseFloat(scale - stepSize).toFixed(4)) {
                    y = columnSize + (yScale * count * stepSize); 
                    context.fillText(Math.abs(scale).toFixed(1), margin,y);
                    context.moveTo(rowSize,y)
                    context.lineTo(canvas.width,y)
                    count++;
                }
                context.stroke();
                
                // print names of each data entry
                context.font = "20 pt Verdana";
                context.textBaseline="bottom";
                for (i=0;i<sections;i++) {
                    computeHeight(itemValue[i]);
                    context.fillText(itemName[i], xScale * (i+1),y - margin);
                }
                
                // shadow for graph's bar lines with color and offset
                context.fillStyle="#9933FF;";
                context.shadowColor = 'rgba(128,128,128, 0.5)';
              
                //shadow offset along X and Y direction 
                context.shadowOffsetX = 9;
                context.shadowOffsetY = 3;
              
                // translate to bottom of graph  inorder to match the data 
                context.translate(0,canvas.height - margin);
                context.scale(xScale,-1 * yScale);
              
                // draw each graph bars 
                for (i=0;i<sections;i++) {
                    context.fillRect(i+1, 0, 0.3, itemValue[i]);
                }
            }
            
            function computeHeight(value) {
                y = canvas.height - value * yScale ;    
            }

            function createReportTable () {
                var table  = $("#reportTable");
                var tBody  = table.find("tbody");
                var idx = 0;

                for (var i = 0; i < itemName.length; i++)   { 
                    tBody.append(
                    '<tr id="row'+idx+'">'+
                        '<td>'+itemFullName[i]+'</td>'+
                        '<td>'+itemValue[i].toFixed(1)+'</td>'+
                    '</tr>'
                    );
                    idx++;
                }
                tBody.append(
                '<tr id="row'+idx+'">'+
                    '<td><b>Total</b></td>'+
                    '<td><b>'+itemTotal.toFixed(1)+'</b></td>'+
                '</tr>'
                );
            }

            $(function() {
                var curselYear =  $('#frame1', window.parent.document)[0].contentWindow.selYear;
                var headerText=document.getElementById('hdrText');
                var idx = 0;

                hdrText.innerHTML = "REPORT OF " + curselYear;
                Val_Max = 0;

                $.get("./php/report.php", {year: curselYear}).
                      done(function(report) {
                    var re_recordRow = /[^@]+/g;
                    var re_recordCellValue = /[^=]+$/;
                    // For all the row entries read from DB 
                    while (m_recordRow = re_recordRow.exec(report)) {
                        itemValue[idx] =  parseFloat(re_recordCellValue.exec(m_recordRow[0]));
                        if (itemValue[idx] > Val_Max) Val_Max = itemValue[idx];
                        itemTotal += itemValue[idx]; 
 
                        idx++;
                    }
                    
                    if (Val_Max >= 10.0) 
                        plotBarGraph();
                    else 
                        $('#canvasSection')[0].style.display='none';

                    createReportTable ();
                })
            })
        </script>
    </head>
    <body>
        <br>
            <div id="hdrText" 
                 align="center" 
                 style="font-family: Arial Black; font-size: 25px; color: black">
                 Report $Year
            </div>
        </br>
        <div id="canvasSection" align="center">
            <canvas id="canvas" width="600" height="400">
                Your browser does not support HTML5 Canvas.
            </canvas>
        </div>
        <table name="reportTable" id="reportTable">
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Expense</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </body>
</html>
